/**
 * Add a create new group modal to the page.
 *
 * @module     core_group/AjaxForms
 * @class      AjaxForms
 * @package
 * @copyright  2022 eAbyas Info Solutions
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_program/ajaxforms",["jquery","core/str","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/yui","core/templates","local_program/select2","local_program/program"],(function($,Str,ModalFactory,ModalEvents,Fragment,Ajax,Y,Templates,select2,program){var AjaxForms=function(args){this.contextid=args.contextid,this.args=args,this.init(args)};return AjaxForms.prototype.modal=null,AjaxForms.prototype.contextid=-1,AjaxForms.prototype.init=function(args){var header_label,self=this;switch(args.callback){case"program_form":if(0===args.id)header_label={key:"createprogram",component:"local_program"};else header_label={key:"updateprogram",component:"local_program"};break;case"session_form":if(0===args.id)header_label={key:"addsession",component:"local_program"};else header_label={key:"updatesession",component:"local_program"};break;case"course_form":if(0===args.id)header_label={key:"addcourses",component:"local_program",param:args.programname};else header_label={key:"updatecourses",component:"local_program"};break;case"program_completion_form":header_label={key:"program_completion_settings",component:"local_program"};break;case"program_curriculum_form":header_label={key:"program_curriculum",component:"local_program"};break;case"program_managelevel_form":if(0===args.id)header_label={key:"addsemester",component:"local_program"};else header_label={key:"updatelevel",component:"local_program"}}return Str.get_strings([header_label,{key:"savecontinue",component:"local_program"},{key:"assign",component:"local_program"},{key:"save",component:"local_program"},{key:"previous",component:"local_program"},{key:"skip",component:"local_program"},{key:"cancel",component:"local_program"}]).then(function(strings){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:strings[0],body:this.getBody(),footer:this.getFooter(strings)})}.bind(this)).then(function(modal){return this.modal=modal,this.modal.setLarge(),this.modal.getRoot().addClass("openLMStransition local_program"),this.modal.getRoot().on(ModalEvents.hidden,function(){this.modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){modal.destroy()}),1e3)}.bind(this)),this.modal.getFooter().find('[data-action="save"]').on("click",this.submitForm.bind(this)),this.modal.getFooter().find('[data-action="cancel"]').on("click",(function(){modal.destroy(),window.location.reload(),args.prevlvlid>0||0==args.prevlvlid?$.ajax({method:"POST",url:M.cfg.wwwroot+"/local/program/ajax.php",data:{action:"programlevelcourses",programid:args.bcid,levelid:args.levelid},success:function(resp){$(".levetabscontent_container").html(resp)}}):"program_curriculum_form"===args.callback||"program_form"===args.callback||("program_addlevel"===args.pluginname||"program_managelevel_form"===args.callback)&&0==args.id?modal.destroy():$.ajax({method:"POST",url:M.cfg.wwwroot+"/local/program/ajax.php",data:{action:"programlevelcourses",programid:args.programid,levelid:args.id},success:function(resp){$(".levetabscontent_container").html(resp)}})})),this.modal.getFooter().find('[data-action="skip"]').on("click",(function(){self.args.form_status=self.args.form_status+1,args.callback;var data=self.getBody();data.then((function(html){!1===html&&(self.handleFormSubmissionResponse(args),$.fn.DataTable.isDataTable("#viewprograms")||$("#viewprograms").dataTable({language:{paginate:{previous:"<",next:">"}},bInfo:!1}).destroy(),program.Datatable())})),modal.setBody(data)})),this.modal.getRoot().on("submit","form",(function(form){self.submitFormAjax(form,self.args)})),this.modal.show(),this.modal.getRoot().animate({right:"0%"},500),$(".close").click((function(){window.location.href=window.location.href+String()})),this.modal.show(),this.modal}.bind(this))},AjaxForms.prototype.getBody=function(formdata){return void 0===formdata&&(formdata={}),this.args.jsonformdata=JSON.stringify(formdata),Fragment.loadFragment(this.args.component,this.args.callback,this.contextid,this.args)},AjaxForms.prototype.getFooter=function(customstrings){var $footer;return $footer='<button id="id_submit" type="button" class="btn btn-primary before_submit" data-action="save">'+customstrings[1]+"</button>&nbsp;",$footer+='<button type="button" class="btn btn-secondary" data-action="cancel">'+customstrings[6]+"</button>&nbsp;",0==this.args.form_status?('style="display:none;"',$footer+='<button id="id_submit" type="button" class="btn btn-secondary" data-action="skip" style="display:none;">'+customstrings[5]+"</button>&nbsp;"):$footer='<button type="button" class="btn btn-secondary" data-action="cancel">'+customstrings[6]+"</button>",$footer},AjaxForms.prototype.handleFormSubmissionResponse=function(args){if(this.modal.destroy(),Y.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()})),-2==args.form_status)if(this.modal.destroy(),args.levelid>0&&(args.prevlvlid>0||0==args.prevlvlid))$(".programlevels #semlvlid"+args.prevlvlid).find("a").trigger("click"),$.ajax({method:"POST",url:M.cfg.wwwroot+"/local/program/ajax.php",data:{action:"programlevelcourses",programid:args.bcid,levelid:args.levelid},success:function(resp){$(".levetabscontent_container").html(resp)}});else if(args.id>0&&args.programid>0){var pop=this.modal;"program_addlevel"===args.pluginname&&(0==args.newsemadd?window.location.href=window.location.href+String():(pop.destroy(),$.ajax({method:"POST",url:M.cfg.wwwroot+"/local/program/ajax.php",data:{action:"programlevelcourses",programid:args.programid,levelid:args.id},success:function(resp){$(".levetabscontent_container").html(resp)}})))}else 0==args.prevlvlid||null==args.prevlvlid?(this.modal.destroy(),$(document).on("click","#page-local-program-view .modal-content .modal-footer .btn-primary",(function(){$.ajax({method:"POST",url:M.cfg.wwwroot+"/local/program/ajax.php",data:{action:"programlevelcourses",programid:args.bcid,levelid:args.levelid},success:function(resp){$(".levetabscontent_container").html(resp)}})})),$(".programlevels #semlvlid"+args.id).find("a").trigger("click"),$("#levtabcont"+args.id+" .tab-content").load(" #levtabcont"+args.id+" .tabcontent")):args.prevlvlid>0||0==args.prevlvlid?$(document).on("click","#page-local-program-view .modal-content .modal-footer .btn-primary",(function(){$.ajax({method:"POST",url:M.cfg.wwwroot+"/local/program/ajax.php",data:{action:"programlevelcourses",programid:args.bcid,levelid:args.levelid},success:function(resp){$(".levetabscontent_container").html(resp)}})})):($(".programlevels #semlvlid"+args.prevlvlid).trigger("click"),$(".programlevels #semlvlid"+args.id).trigger("click"));"program_form"===args.callback&&function(args){$.ajax({type:"POST",url:M.cfg.wwwroot+"/local/program/ajax.php",data:{programid:args.id,action:"programlastchildpopup",sesskey:M.cfg.sesskey},success:function(returndata){ModalFactory.create({title:Str.get_string("program_info","local_program"),body:returndata}).done((function(modal){modal.show(),modal.setLarge(),modal.getRoot().addClass("openLMStransition"),modal.getRoot().animate({right:"0%"},500),modal.getRoot().on(ModalEvents.hidden,function(){modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){modal.destroy()}),1e3)}.bind(this)),$(".close").click((function(){window.location.href=window.location.href+String()}))}))}})}(args),"program_addlevel"===args.pluginname&&window.location.reload()},AjaxForms.prototype.handleFormSubmissionFailure=function(data){this.modal.setBody(this.getBody(data))},AjaxForms.prototype.submitFormAjax=function(e,args){e.preventDefault();var self=this,formData=this.modal.getRoot().find("form").serialize(),methodname=args.plugintype+"_"+args.pluginname+"_submit_instance",params={};params.contextid=this.contextid,params.jsonformdata=JSON.stringify(formData),params.form_status=args.form_status;var promise=Ajax.call([{methodname:methodname,args:params}]);$(document).on("click","#id_submit",(function(){$(this).removeClass("before_submit").addClass("not-allowed")})),promise[0].done((function(resp){self.args.form_status=resp.form_status,resp.form_status>=0&&!1!==resp.form_status?(self.args.form_status=resp.form_status,self.args.id=resp.id,self.handleFormSubmissionFailure()):(self.args.id=resp.id,self.handleFormSubmissionResponse(self.args)),args.form_status>0&&$('[data-action="skip"]').css("display","inline-block")})).fail((function(){self.handleFormSubmissionFailure(formData)}))},AjaxForms.prototype.submitForm=function(e){e.preventDefault(),this.modal.getRoot().find("form").submit()},{init:function(args){return new AjaxForms(args)},load:function(){}}}));

//# sourceMappingURL=ajaxforms.min.js.map