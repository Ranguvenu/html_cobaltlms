/**
 * Add a create new group modal to the page.
 *
 * @module     local_users/newuser
 * @class      NewUser
 * @package
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_users/newuser",["jquery","core/str","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/yui","local_courses/jquery.dataTables"],(function($,Str,ModalFactory,ModalEvents,Fragment,Ajax,Y){var NewUser=function(args){this.contextid=args.context,this.id=args.id;this.args=args,this.init(args)};return NewUser.prototype.modal=null,NewUser.prototype.contextid=-1,NewUser.prototype.init=function(){var self=this;if(self.id)var strings=Str.get_strings([{key:"edituser",component:"local_users"},{key:"save_continue",component:"local_users"},{key:"previous",component:"local_users"},{key:"cancel",component:"local_users"}]);else strings=Str.get_strings([{key:"adnewuser",component:"local_users"},{key:"save_continue",component:"local_users"},{key:"previous",component:"local_users"},{key:"cancel",component:"local_users"}]);return strings.then(function(strings){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:strings[0],body:this.getBody(),footer:this.getFooter(strings)})}.bind(this)).then(function(modal){return this.modal=modal,this.modal.setLarge(),this.modal.getRoot().addClass("openLMStransition local_users"),this.modal.getRoot().on(ModalEvents.hidden,function(){this.modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){modal.destroy()}),500)}.bind(this)),this.modal.getFooter().find('[data-action="save"]').on("click",this.submitForm.bind(this)),this.modal.getFooter().find('[data-action="cancel"]').on("click",(function(){modal.hide(),setTimeout((function(){modal.destroy()}),500),window.location.reload()})),this.modal.getFooter().find('[data-action="previous"]').on("click",(function(){self.args.form_status=self.args.form_status-1;var data=self.getBody();data.then((function(html){!1===html&&window.location.reload()})),modal.setBody(data),0==self.args.form_status?$('[data-action="previous"]').css("display","none"):$('[data-action="previous"]').css("display","block")})),this.modal.getRoot().on("submit","form",(function(form){self.submitFormAjax(form,self.args)})),this.modal.show(),this.modal.getRoot().animate({right:"0%"},500),this.modal}.bind(this))},NewUser.prototype.getBody=function(formdata){return void 0===formdata&&(formdata={}),this.args.jsonformdata=JSON.stringify(formdata),Fragment.loadFragment("local_users","new_create_user",this.contextid,this.args)},NewUser.prototype.getFooter=function(strings){var $footer;return $footer='<button type="button" class="btn btn-primary" data-action="save">'+strings[1]+"</button>&nbsp;",'style="display:none;"',$footer+='<button type="button" class="btn btn-secondary" data-action="previous" style="display:none;" >'+strings[2]+"</button>&nbsp;",$footer+='<button type="button" class="btn btn-secondary" data-action="cancel">'+strings[3]+"</button>"},NewUser.prototype.handleFormSubmissionResponse=function(){this.modal.hide(),Y.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()}));var context={id:undefined.id},modalPromise=ModalFactory.create({type:ModalFactory.types.DEFAULT,body:undefined.render("local_classroom/classroomview",context)});$.when(modalPromise).then((function(){})).fail(Notification.exception)},NewUser.prototype.handleFormSubmissionFailure=function(data){this.modal.setBody(this.getBody(data))},NewUser.prototype.submitFormAjax=function(e,args){e.preventDefault();var self=this,formData=this.modal.getRoot().find("form").serialize(),params={};params.contextid=this.contextid,params.jsonformdata=JSON.stringify(formData),params.form_status=args.form_status,Ajax.call([{methodname:"local_users_submit_create_user_form",args:params}])[0].done((function(resp){-1!==resp.form_status&&!1!==resp.form_status?(self.args.form_status=resp.form_status,self.args.id=resp.id,self.handleFormSubmissionFailure()):(self.modal.hide(),window.location.reload()),args.form_status>0&&$('[data-action="previous"]').css("display","inline-block")})).fail((function(){self.handleFormSubmissionFailure(formData)}))},NewUser.prototype.submitForm=function(e){e.preventDefault();this.modal.getRoot().find("form").submit()},{init:function(args){return new NewUser(args)},load:function(){$(document).on("change","#id_open_costcenterid",(function(){var costcentervalue=$(this).find("option:selected").val();if(null!==costcentervalue){var params={};params.costcenterid=costcentervalue,params.contextid=1,Ajax.call([{methodname:"local_users_get_departments_list",args:params}])[0].done((function(resp){resp=JSON.parse(resp);var template="";$.each(resp,(function(index,value){template+="<option value = "+index+" >"+value+"</option>"})),$("#id_open_departmentid").html(template)}))}$("#id_open_departmentid").trigger("change"),$("#id_open_subdepartment").trigger("change")})),$(document).on("change","#id_open_departmentid",(function(){var departmentvalue=$(this).find("option:selected").val();if(null!==departmentvalue){var params={};params.departmentid=departmentvalue,params.contextid=1,Ajax.call([{methodname:"local_users_get_subdepartments_list",args:params}])[0].done((function(resp){resp=JSON.parse(resp);var template="";$.each(resp,(function(index,value){template+="<option value = "+index+" >"+value+"</option>"})),$("#id_open_subdepartment").html(template)}))}})),$(document).on("change","#id_open_costcenterid",(function(){var costcentervalue=$(this).find("option:selected").val();if(0!=costcentervalue){var params={};params.costcenterid=costcentervalue,params.contextid=1,Ajax.call([{methodname:"local_users_get_supervisors_list",args:params}])[0].done((function(resp){resp=JSON.parse(resp);var template="";$.each(resp,(function(index,value){template+="<option value = "+index+" >"+value+"</option>"})),$("#open_supervisorid").html(template)}))}$("#open_supervisorid").trigger("change")}))},deleteConfirm:function(args){return Str.get_strings([{key:"confirm"},{key:"deleteconfirm",component:"local_users",param:args},{key:"deleteallconfirm",component:"local_users"},{key:"delete"}]).then(function(s){ModalFactory.create({title:s[0],type:ModalFactory.types.SAVE_CANCEL,body:s[1]}).done(function(modal){this.modal=modal,modal.setSaveButtonText(s[3]),modal.getRoot().on(ModalEvents.save,function(e){e.preventDefault(),args.confirm=!0;var params={};params.id=args.id,params.contextid=args.contextid,Ajax.call([{methodname:"local_users_"+args.action,args:params}])[0].done((function(){window.location.href=window.location.href+String()})).fail((function(){}))}.bind(this)),modal.show()}.bind(this))}.bind(this))},notdeleteConfirm:function(args){return Str.get_strings([{key:"confirm"},{key:"notdeleteuser",component:"local_users",param:args}]).then(function(s){ModalFactory.create({title:s[0],body:s[1]}).done(function(modal){this.modal=modal,modal.getRoot().on(ModalEvents.save,function(e){e.preventDefault(),args.confirm=!0;var params={};params.id=args.id,params.contextid=args.contextid,Ajax.call([{methodname:"local_users_"+args.action,args:params}])[0].done((function(){window.location.href=window.location.href+String()})).fail((function(){}))}.bind(this)),modal.show()}.bind(this))}.bind(this))},notsuspendConfirm:function(args){return Str.get_strings([{key:"confirm"},{key:"notsuspenduser",component:"local_users",param:args}]).then(function(s){ModalFactory.create({title:s[0],body:s[1]}).done(function(modal){this.modal=modal,modal.getRoot().on(ModalEvents.save,function(e){e.preventDefault(),args.confirm=!0;var params={};params.id=args.id,params.contextid=args.contextid,Ajax.call([{methodname:"local_users_"+args.action,args:params}])[0].done((function(){window.location.href=window.location.href+String()})).fail((function(){}))}.bind(this)),modal.show()}.bind(this))}.bind(this))},batchdeleteConfirm:function(args){return Str.get_strings([{key:"confirm"},{key:"batchdeleteuser",component:"local_users",param:args}]).then(function(s){ModalFactory.create({title:s[0],body:s[1]}).done(function(modal){this.modal=modal,modal.getRoot().on(ModalEvents.save,function(e){e.preventDefault(),args.confirm=!0;var params={};params.id=args.id,params.contextid=args.contextid,Ajax.call([{methodname:"local_users_"+args.action,args:params}])[0].done((function(){window.location.href=window.location.href+String()})).fail((function(){}))}.bind(this)),modal.show()}.bind(this))}.bind(this))},userSuspend:function(args){return Str.get_strings([{key:"confirm"},{key:"suspendconfirm"+args.status,component:"local_users",param:args},{key:"suspendallconfirm",component:"local_users"},{key:"confirm"}]).then(function(s){ModalFactory.create({title:s[0],type:ModalFactory.types.SAVE_CANCEL,body:s[1]}).done(function(modal){this.modal=modal,modal.setSaveButtonText(s[3]),modal.getRoot().on(ModalEvents.save,function(e){e.preventDefault(),args.confirm=!0;var params={};params.id=args.id,params.contextid=args.contextid,Ajax.call([{methodname:"local_users_suspend_user",args:params}])[0].done((function(){window.location.href=window.location.href+String()})).fail((function(){}))}.bind(this)),modal.show()}.bind(this))}.bind(this))}}}));

//# sourceMappingURL=newuser.min.js.map