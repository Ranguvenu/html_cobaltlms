/**
 * Add a create new group modal to the page.
 *
 * @module     local_courses/courseAjaxform
 * @class      courseAjaxform
 * @package
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("local_courses/courseAjaxform",["local_courses/jquery.dataTables","jquery","core/str","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/yui","core/templates"],(function(dataTable,$,Str,ModalFactory,ModalEvents,Fragment,Ajax,Y,Templates){var courseAjaxform=function(args){this.contextid=args.contextid||1,this.args=args,this.init(args)};return courseAjaxform.prototype.modal=null,courseAjaxform.prototype.contextid=-1,courseAjaxform.prototype.init=function(args){var self=this;if(args.courseid)if("custom_selfcompletion_form"===args.callback)var head={key:"selfcompletionname",component:"local_courses",param:args.coursename};else if(args.userid)head={key:"browseevidencesname",component:"local_courses",param:args.coursename};else head={key:"editcourse",component:"local_courses"};else head={key:"createnewcourse",component:"local_courses"};return Str.get_strings([head,{key:"yes",component:"customfield"},{key:"no",component:"customfield"},{key:"saveandcontinue",component:"local_courses"},{key:"cancel",component:"moodle"}]).then(function(strings){return ModalFactory.create({type:ModalFactory.types.DEFAULT,title:strings[0],body:this.getBody(),footer:this.getFooter(strings)})}.bind(this)).then(function(modal){return this.modal=modal,"custom_selfcompletion_form"!=args.callback&&(this.modal.setLarge(),this.modal.getRoot().addClass("openLMStransition local_courses"),this.modal.getRoot().on(ModalEvents.hidden,function(){this.modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){modal.destroy()}),1e3),this.modal.setBody("")}.bind(this))),"custom_selfcompletion_form"==args.callback?(this.modal.getFooter().find('[data-action="save"]').on("click",(function(){window.location.href=M.cfg.wwwroot+"/course/togglecompletion.php?confirm=1&course="+args.courseid+"&sesskey="+M.cfg.sesskey})),this.modal.getFooter().find('[data-action="cancel"]').on("click",(function(){window.location.reload()})),this.modal.getRoot().find('[data-action="hide"]').on("click",(function(){window.location.reload()}))):(this.modal.footer.find('[data-action="save"]').on("click",this.submitForm.bind(this)),this.modal.getFooter().find('[data-action="cancel"]').on("click",(function(){modal.setBody(""),modal.hide(),setTimeout((function(){modal.destroy()}),1e3),0!==args.form_status&&window.location.reload()})),this.modal.getRoot().find('[data-action="hide"]').on("click",(function(){modal.hide(),setTimeout((function(){modal.destroy()}),1e3),0!==args.form_status&&window.location.reload()}))),this.modal.getRoot().on("submit","form",(function(form){self.submitFormAjax(form,self.args)})),this.modal.show(),this.modal.getRoot().animate({right:"0%"},500),this.modal}.bind(this))},courseAjaxform.prototype.getBody=function(formdata){return void 0===formdata&&(formdata={}),this.args.jsonformdata=JSON.stringify(formdata),Fragment.loadFragment(this.args.component,this.args.callback,this.contextid,this.args)},courseAjaxform.prototype.getFooter=function(customstrings){var footer="";return"custom_selfcompletion_form"===this.args.callback?(footer+='<button type="button" class="btn btn-primary" data-action="save">'+customstrings[1]+"</button>&nbsp;",footer+='<button type="button" class="btn btn-secondary" data-action="cancel">'+customstrings[2]+"</button>"):"userview"!=this.args.viewtype&&(footer+='<button type="button" class="btn btn-primary" data-action="save">'+customstrings[3]+"</button>&nbsp;",footer+='<button type="button" class="btn btn-secondary" data-action="cancel">'+customstrings[4]+"</button>"),footer},courseAjaxform.prototype.getcontentFooter=function(){return Str.get_strings([{key:"cancel"}]).then(function(s){return'<button type="button" class="btn btn-secondary" data-action="cancel">'+s[0]+"</button>"}.bind(this))},courseAjaxform.prototype.handleFormSubmissionResponse=function(args){if(this.modal.hide(),Y.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()})),!args.userid)return Str.get_strings([{key:"courseoverview",component:"local_courses"}]).then(function(s){var context={courseid:args.courseid,configpath:M.cfg.wwwroot,enrolid:args.enrolid,contextid:args.contextid},modalPromise=ModalFactory.create({type:ModalFactory.types.DEFAULT,body:Templates.render("local_courses/courses",context),footer:this.getcontentFooter()});$.when(modalPromise).then((function(modal){return modal.setTitle(s[0]),modal.setLarge(),modal.getRoot().addClass("openLMStransition"),modal.show(),modal.getRoot().animate({right:"0%"},500),modal.getRoot().on(ModalEvents.hidden,function(){modal.destroy()}.bind(this)),modal.getFooter().find('[data-action="cancel"]').on("click",(function(){modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){window.location.reload()}),600)})),modal.getRoot().find('[data-action="hide"]').on("click",(function(){modal.getRoot().animate({right:"-85%"},500),setTimeout((function(){window.location.reload()}),200)})),modal})).fail(Notification.exception),$("#coursesearch").dataTable().destroy()}.bind(this));this.modal.hide()},courseAjaxform.prototype.handleFormSubmissionFailure=function(data){this.modal.setBody(this.getBody(data))},courseAjaxform.prototype.submitFormAjax=function(e,args){e.preventDefault();var self=this,formData=this.modal.getRoot().find("form").serialize();if(args.userid)var methodname=args.plugintype+"_"+args.pluginname+"_submit_evidence_course_form";else methodname=args.plugintype+"_"+args.pluginname+"_submit_create_course_form";var params={};params.contextid=this.contextid,params.jsonformdata=JSON.stringify(formData),params.form_status=args.form_status,Ajax.call([{methodname:methodname,args:params}])[0].done((function(resp){self.args.courseid=resp.courseid,self.args.enrolid=resp.enrolid,-1!==resp.form_status&&!1!==resp.form_status?(self.args.form_status=resp.form_status,self.handleFormSubmissionFailure()):self.handleFormSubmissionResponse(self.args)})).fail((function(){self.handleFormSubmissionFailure(formData)}))},courseAjaxform.prototype.submitForm=function(e){e.preventDefault(),this.modal.getRoot().find("form").submit()},{init:function(args){return new courseAjaxform(args)},deleteConfirm:function(args){return Str.get_strings([{key:"confirm"},{key:"deleteconfirm",component:"local_courses",param:args},{key:"deleteallconfirm",component:"local_courses"},{key:"delete"},{key:"yesdelete",component:"local_courses"},{key:"no",component:"local_courses"}]).then(function(s){ModalFactory.create({title:s[0],type:ModalFactory.types.DEFAULT,body:s[1],footer:'<button type="button" class="btn btn-secondary" data-action="cancel">'+s[5]+'</button>&nbsp;<button type="button" class="btn btn-primary" data-action="save">'+s[4]+"</button>"}).done(function(modal){this.modal=modal,modal.getRoot().find('[data-action="save"]').on("click",function(){args.confirm=!0,Ajax.call([{methodname:"local_courses_"+args.action,args:args}])[0].done((function(){window.location.href=window.location.href+String()})).fail((function(){}))}.bind(this)),modal.getFooter().find('[data-action="cancel"]').on("click",(function(){modal.setBody(""),modal.hide()})),modal.show()}.bind(this))}.bind(this))},getCatlist:function(){$("#id_open_costcenterid").on("change",(function(){return Str.get_strings([{key:"selectdept",component:"local_courses"},{key:"selectcat",component:"local_courses"},{key:"selectlevel",component:"local_courses"},{key:"select_certificate",component:"local_courses"},{key:"errorinrequestprocessing",component:"local_courses"}]).then(function(s){var orgID=$(this).val();if(orgID){Ajax.call([{methodname:"local_courses_departmentlist",args:{orgid:orgID,depid:0,flag:0}}])[0].done((function(resp){var template="<option value=null>"+s[0]+"</option>";$.each(JSON.parse(resp.departments),(function(index,value){template+="<option value = "+index+" >"+value+"</option>"})),$("#id_open_departmentid").html(template);var cattemplate="<option value=''>"+s[1]+"</option>";$.each(JSON.parse(resp.categories),(function(index,value){cattemplate+="<option value = "+index+" >"+value+"</option>"})),$("#id_category").html(cattemplate);var leveltemplate="<option value=''>"+s[2]+"</option>";$.each(JSON.parse(resp.levels),(function(index,value){leveltemplate+="<option value = "+index+" >"+value+"</option>"})),$("#id_open_level").html(leveltemplate);var certtemplate="<option value=''>"+s[3]+"</option>";$.each(JSON.parse(resp.certificates),(function(index,value){certtemplate+="<option value = "+index+" >"+value+"</option>"})),$("#id_open_certificateid").html(certtemplate)})).fail((function(){}))}else{var template="<option value=''>"+s[0]+"</option>";$("#id_open_departmentid").html(template);var cattemplate="<option value=''>"+s[1]+"</option>";$("#id_category").html(cattemplate);var leveltemplate="<option value=''>"+s[2]+"</option>";$("#id_open_level").html(leveltemplate);var certtemplate="<option value=''>"+s[3]+"</option>";$("#id_open_certificateid").html(certtemplate)}}.bind(this))})),$("#id_open_departmentid").on("change",(function(){return Str.get_strings([{key:"selectcat",component:"local_courses"},{key:"selectsubdept",component:"local_courses"},{key:"errorinrequestprocessing",component:"local_courses"},{key:"selectdept",component:"local_courses"}]).then(function(s){var depID=$(this).val();if(depID&&"null"!=depID){Ajax.call([{methodname:"local_courses_departmentlist",args:{orgid:0,depid:depID,flag:1}}])[0].done((function(resp){var cattemplate="<option value=''>"+s[0]+"</option>";$.each(JSON.parse(resp.categories),(function(index,value){cattemplate+="<option value = "+index+" >"+value+"</option>"})),$("#id_category").html(cattemplate)})).fail((function(){}));var params={};params.departmentid=depID,params.contextid=1,Ajax.call([{methodname:"local_users_get_subdepartments_list",args:params}])[0].done((function(resp){resp=JSON.parse(resp);var template="";$.each(resp,(function(index,value){template+="<option value = "+index+" >"+value+"</option>"})),$("#id_open_subdepartment").html(template)}))}else{var empty_subdept_template="<option>"+s[1]+"</option>";if($("#id_open_subdepartment").html(empty_subdept_template),!(costcenter=$("#id_open_costcenterid").val()))var costcenter=$('input[name="open_costcenterid"]').val();if(costcenter)Ajax.call([{methodname:"local_courses_departmentlist",args:{orgid:costcenter,depid:0,flag:0}}])[0].done((function(resp){var template="<option value=null>"+s[3]+"</option>";$.each(JSON.parse(resp.departments),(function(index,value){template+="<option value = "+index+" >"+value+"</option>"})),$("#id_open_departmentid").html(template);var cattemplate="<option value=''>"+s[0]+"</option>";$.each(JSON.parse(resp.categories),(function(index,value){cattemplate+="<option value = "+index+" >"+value+"</option>"})),$("#id_category").html(cattemplate)})).fail((function(){}))}}.bind(this))})),$("#id_open_subdepartment").on("change",(function(){return Str.get_strings([{key:"selectcat",component:"local_courses"},{key:"errorinrequestprocessing",component:"local_courses"}]).then(function(s){var subdepID=$(this).val();if(subdepID&&0!=subdepID&&"null"!=subdepID){Ajax.call([{methodname:"local_courses_departmentlist",args:{orgid:0,depid:subdepID,flag:1}}])[0].done((function(resp){var cattemplate="<option value=''>"+s[0]+"</option>";$.each(JSON.parse(resp.categories),(function(index,value){cattemplate+="<option value = "+index+" >"+value+"</option>"})),$("#id_category").html(cattemplate)})).fail((function(){}))}else{var depID=$("#id_open_departmentid").val();if(depID&&"null"!=depID)Ajax.call([{methodname:"local_courses_departmentlist",args:{orgid:0,depid:depID,flag:1}}])[0].done((function(resp){var cattemplate="<option value=''>"+s[0]+"</option>";$.each(JSON.parse(resp.categories),(function(index,value){cattemplate+="<option value = "+index+" >"+value+"</option>"})),$("#id_category").html(cattemplate)})).fail((function(){}))}}.bind(this))}))},coursenotdelete:function(args){return Str.get_strings([{key:"confirm"},{key:"cannotdelete",component:"local_courses",param:args.name}]).then(function(s){ModalFactory.create({title:s[0],type:ModalFactory.types.DEFAULT,body:s[1]}).done(function(modal){this.modal=modal,modal.show()}.bind(this))}.bind(this))},coursenothide:function(args){return Str.get_strings([{key:"confirm"},{key:"cannothide",component:"local_courses",param:args.name}]).then(function(s){ModalFactory.create({title:s[0],type:ModalFactory.types.DEFAULT,body:s[1]}).done(function(modal){this.modal=modal,modal.show()}.bind(this))}.bind(this))},load:function(){}}}));

//# sourceMappingURL=courseAjaxform.min.js.map